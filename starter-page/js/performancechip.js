//weight is mapped to size in d3js


var geneticData = {
 "name": "Performance",
 "type": "root", 
 "children": [
  {
   "name": "Endurance",
   "type": "category",
   "linkcolor": "#00a65a",
   "className" : "endurance",
   "children": [
    {
     "name": "Heart Capacity",
     "type": "phenotype",
     "linkcolor": "#00a65a",
     "className" : "endurance",
     "children": [
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 24234", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 1,
        "size": 4
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 9
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 9
      }
     ]
    },
    {
     "name": "Endurance",
     "type": "phenotype",
     "linkcolor": "#00a65a",
     "className" : "endurance",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 1,
        "size": 9
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 9
      }
     ]
    }
   ]
  },
  {
   "name": "Power",
   "type": "category",
   "linkcolor": "#00c0ef",
   "className" : "power",
   "children": [
    {
     "name": "Strength",
     "type": "phenotype",
     "linkcolor": "#00c0ef",
     "className" : "power",
     "children": [
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 24234", 
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 1,
        "size": 4
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 2,
        "size": 9
      }
      
     ]
    },
    {
     "name": "Power Capacity",
     "type": "phenotype",
     "linkcolor": "#00c0ef",
     "className" : "power",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 1,
        "size": 9
      }
     ]
    }
   ]
  },
  {
   "name": "Metabolism",
   "type": "category",
   "linkcolor": "#0073b7",
   "className" : "metabolism",
   "children": [
    {
     "name": "Energy",
     "type": "phenotype",
     "linkcolor": "#0073b7",
     "className" : "metabolism",
     "children": [
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 24234", 
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 1,
        "size": 4
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 2,
        "size": 9
      }
      
     ]
    },
    {
     "name": "Propensity to Exercise",
     "type": "phenotype",
     "linkcolor": "#0073b7",
     "className" : "metabolism",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 1,
        "size": 9
      }
     ]
    }
   ]
  },
  {
   "name": "Recovery",
   "type": "category",
   "linkcolor": "#f56954",
   "className" : "recovery",
   "children": [
    {
     "name": "Recovery",
     "type": "phenotype",
     "linkcolor": "#f56954",
     "className" : "recovery",
     "children": [
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 24234", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 1,
        "size": 4
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 9
      }
      
     ]
    },
    {
     "name": "Muscle Fatigue",
     "type": "phenotype",
     "linkcolor": "#f56954",
     "className" : "recovery",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 1,
        "size": 9
      }
     ]
    },
    {
     "name": "Lung Capacity",
     "type": "phenotype",
     "linkcolor": "#f56954",
     "className" : "recovery",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 1,
        "size": 9
      }
     ]
    }
   ]
  }
 ]
};

var w = 180 - 80,
    h = 240 - 180,
    x = d3.scale.linear().range([0, w]),
    y = d3.scale.linear().range([0, h]),
    root,
    node;

// Has the color mapping for different categories Using color brewer


var color = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.YlOrRd[3]);
var enduranceColor = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.Greens[3]);
var powerColor = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.Purples[3]);
var metabolismColor = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.YlOrRd[3]);
var recoveryColor = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.Blues[3]);


var treemap = d3.layout.treemap()
    .round(false)
    .size([w, h])
    .sticky(true)
    .value(function (d) {
    return d.size;
});

var svg = d3.select(".viz").append("div")
    .attr("class", "chart")
    .style("width", w + "px")
    .style("height", h + "px")
    .append("svg:svg")
    .attr("width", w)
    .attr("height", h)
    .append("svg:g")
    .attr("transform", "translate(.5,.5)");


node = root = geneticData;

var nodes = treemap.nodes(root)
    .filter(function (d) {
    return !d.children;
});

var cell = svg.selectAll("g")
    .data(nodes)
    .enter().append("svg:g")
    .attr("class", "cell")
    .attr("transform", function (d) {
    return "translate(" + d.x + "," + d.y + ")";
})
    .on("click", function (d) {
    return zoom(node == d.parent ? root : d.parent);
});

cell.append("svg:rect")
    .attr("width", function (d) {
    return d.dx - 1;
})
    .attr("height", function (d) {
    return d.dy - 1;
})
    .style("fill", function (d) {
      if (d.className == "endurance") {
        return enduranceColor(d.value);
      }
      if (d.className == "power") {
        return powerColor(d.value);
      }
      if (d.className == "metabolism") {
        return metabolismColor(d.value);
      }
      if (d.className == "recovery") {
        return recoveryColor(d.value);
      }
    return color(d.value);
});

cell.append("svg:text")
    .attr("x", function (d) {
    return d.dx / 2;
})
    .attr("y", function (d) {
    return d.dy / 2;
})
    .attr("dy", ".35em")
    .attr("text-anchor", "middle")
    .text(function (d) {
    return d.name;
})
    .style("opacity", function (d) {
    d.w = this.getComputedTextLength();
    return d.dx > d.w ? 1 : 0;
});

d3.select(window).on("click", function () {
    zoom(root);
});

d3.select("select").on("change", function () {
    treemap.value(this.value == "size" ? size : count).nodes(root);
    zoom(node);
});

function size(d) {
    return d.size;
}

function count(d) {
    return 1;
}

function zoom(d) {
    var kx = w / d.dx,
        ky = h / d.dy;
    x.domain([d.x, d.x + d.dx]);
    y.domain([d.y, d.y + d.dy]);

    var t = svg.selectAll("g.cell").transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .attr("transform", function (d) {
        return "translate(" + x(d.x) + "," + y(d.y) + ")";
    });

    t.select("rect")
        .attr("width", function (d) {
        return kx * d.dx - 1;
    })
        .attr("height", function (d) {
        return ky * d.dy - 1;
    })

    t.select("text")
        .attr("x", function (d) {
        return kx * d.dx / 2;
    })
        .attr("y", function (d) {
        return ky * d.dy / 2;
    })
        .style("opacity", function (d) {
        return kx * d.dx > d.w ? 1 : 0;
    });

    node = d;
    d3.event.stopPropagation();
}